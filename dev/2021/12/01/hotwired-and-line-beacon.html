<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/png" href="/images/favicon.png">

<title>Hotwired and Line Beacon | KT</title>

<meta name="description" content="My personal blog. Interesting in Ruby, Rails and more." />
<!-- Begin Bridgetown SEO tag v5.0.0 -->
<title>Hotwired and Line Beacon | KT</title>
<meta property="og:title" content="Hotwired and Line Beacon" />
<meta name="author" content="Karn" />
<meta property="og:locale" content="th" />
<meta name="description" content="Hotwired มาใช้อัพเดตข้อมูลที่มาจาก Line Beacon มาประยุกต์ใช้กับกิจกรรม Rally กันดูหน่อยว่าจะออกมาเป็นอย่างไร" />
<meta property="og:description" content="Hotwired มาใช้อัพเดตข้อมูลที่มาจาก Line Beacon มาประยุกต์ใช้กับกิจกรรม Rally กันดูหน่อยว่าจะออกมาเป็นอย่างไร" />
<meta property="og:site_name" content="KT" />
<meta property="og:image" content="/images/posts/2021/hotwired-and-line-beacon/cover.png" />
<meta property="og:image:height" content="800" />
<meta property="og:image:width" content="1200" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-12-01T15:05:00+07:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="/images/posts/2021/hotwired-and-line-beacon/cover.png" />
<meta property="twitter:title" content="Hotwired and Line Beacon" />
<!-- End Bridgetown SEO tag -->

<link rel="stylesheet" href="/_bridgetown/static/index.NGPCTLGW.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script type="module">
  import 'https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js';
</script>
<script defer data-domain="karn18.github.io" src="https://analytics.karn.work/js/plausible.js"></script>
<script src="/_bridgetown/static/index.QYWZG4PN.js" defer></script>


  </head>
  <body class="post ">
    <nav>
  <ul>
    <li><a href="/">Home</a></li>
    
    
  </ul>
</nav>

    <main>
      <main data-controller="lightbox">
  <h1>Hotwired and Line Beacon</h1>

  <p>ช่วงนี้ใกล้จะเทศกาลคริสมาสต์แล้วก็จะมีการเปิดกล่องของขวัญกัน ดังนั้นในบทความนี้เราจะมาลองพัฒนา<strong>แคมเปญเปิดกล่องของขวัญวันคริสมาสต์</strong> โดยใช้ <strong>Hotwired</strong> และ <strong>Line Beacon</strong> กัน ทั้งนี้เพื่อเพิ่มความน่าสนใจในการเข้าถึงลูกค้าผ่าน <strong>Line OA</strong></p>

<h2 id="ไอเดีย">ไอเดีย</h2>

<p><img src="/images/posts/2021/hotwired-and-line-beacon/scenario.png" alt="" width="600px" />
<em>Scenario</em></p>

<p>ก่อนอื่นเราก็ต้องมี <strong>Line OA</strong> ก่อน จากนั้นเราก็เชื่อมต่อ beacon เข้ากับ <strong>Line OA</strong> ของเราที่จะใช้งาน ส่วนสำคัญที่ต้องทำต่อคือการสร้าง <strong>Line Messaging API</strong> ไว้สำหรับจัดการ Webhook เมื่อได้รับสัญญาณ beacon และสร้าง <strong>Line Login</strong> ไว้สำหรับ <strong>LIFF</strong> ในการเปิดกล่องของขวัญ</p>

<p>สำหรับในฝั่งของ <strong>Rails</strong> เราจะใช้ <strong>Hotwired</strong> ในการ interact กับหน้าเว็บแบบ realtime ดังนั้นสิ่งที่ต้องสร้างเข้าไปในหน้าเว็บของเราคือการเพิ่ม <code class="highlighter-rouge">turbo_stream_from</code> เข้าไปในหน้า dashboard เพื่อเปิดช่องทาง Web Socket สำหรับให้ server สามารถส่งข้อมูลมายัง client ได้</p>

<p>ในช่องการแสดงผลที่จะอัพเดตเราจะใช้ <code class="highlighter-rouge">turbo_frame_tag</code> สำหรับแสดงข้อมูลผู้ใช้งานที่ต่อกับ beacon และแสดงข้อมูลผู้ใช้งานที่ได้กดเปิดกล่องของขวัญ</p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;main&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">turbo_stream_from</span> <span class="s2">"my_dashboard"</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"flex"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"w-full px-4 lg: w-1/2"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"p-4 text-lg font-bold"</span><span class="nt">&gt;</span>Beacon: #<span class="cp">&lt;%=</span> <span class="vi">@beacon</span><span class="p">.</span><span class="nf">name</span> <span class="cp">%&gt;</span><span class="nt">&lt;/h1&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">turbo_frame_tag</span> <span class="s2">"notifications"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"my-6"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@notifications</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"w-full px-4 lg:w-1/2"</span><span class="nt">&gt;</span>
      <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"p-4 text-lg font-bold"</span><span class="nt">&gt;</span>Lucky Box<span class="nt">&lt;/h1&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">turbo_frame_tag</span> <span class="s2">"boxes"</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"my-6"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="vi">@boxes</span> <span class="cp">%&gt;</span>
      <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/main&gt;</span>
</code></pre></div></div>

<p>จากขั้นตอนเมื่อระบบได้รับ Webhook เมื่อมี beacon ต่อเข้ามาแล้ว จะทำการสร้างโมเดลเก็บเอาไว้ และทันทีหลังจากที่ข้อมูลถูกบันทึก เราจะทำการ broadcast ส่ง HTML กลับไปยังหน้าเว็บผ่าน Web Socket ผ่าน <code class="highlighter-rouge">broadcast_prepend_to</code></p>

<div class="language-rb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/models/notification.rb</span>
<span class="n">after_create_commit</span> <span class="ss">:broadcast_create_later</span>
<span class="k">def</span> <span class="nf">broadcast_create_later</span>
  <span class="n">broadcast_prepend_to</span> <span class="s2">"my_dashboard"</span><span class="p">,</span> <span class="ss">target: </span><span class="s2">"notifications"</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="ผลลัพท์การพัฒนา">ผลลัพท์การพัฒนา</h2>

<video controls="" playsinline="">
  <source src="/videos/hotwired_and_line_beacon.mov" type="video/mp4" />
</video>

<p><img src="/images/posts/2021/hotwired-and-line-beacon/screenshot_1.png" alt="" width="600px" />
<em>Alpha</em></p>

<p><img src="/images/posts/2021/hotwired-and-line-beacon/screenshot_2.png" alt="" width="600px" />
<em>Unbox with Line LIFF</em></p>

<h2 id="references">References</h2>
<ul>
  <li><a href="https://hotwired.dev/">Hotwired</a></li>
  <li><a href="https://developers.line.biz/en/docs/messaging-api/using-beacons/">Line Beacon</a></li>
</ul>

</main>

    </main>
  </body>
</html>
