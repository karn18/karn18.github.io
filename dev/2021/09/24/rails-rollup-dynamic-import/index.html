<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/png" href="/images/favicon.png">

<title>Rails+Rollup+Dynamic Import | KT</title>

<meta name="description" content="Write an awesome description for your new site here. It will appear in your document head meta (for Google search results) and in your feed.xml site description." />

<link rel="stylesheet" href="/karn.work/_bridgetown/static/index.KTVN5CND.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script type="module">
  import 'https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js';
</script>
<script src="/karn.work/_bridgetown/static/index.OWF3DFHJ.js" defer></script>


  </head>
  <body class="post ">
    <nav>
  <ul>
    <li><a href="/karn.work/">Home</a></li>
    
    
  </ul>
</nav>

    <main>
      <main data-controller="lightbox">
  <h1>Rails+Rollup+Dynamic Import</h1>

  <p>ไม่ใช่เรื่องง่ายสักทีเดียวที่จะถอด <strong>Webpack</strong> ออกจากโปรเจ็ค ด้วยความที่เรายังคงใช้ <strong>Magic Comment</strong> ซึ่งมีเฉพาะใน <strong>Webpack</strong> เท่านั้นในการจัดการ dynamic import อีกทั้ง code splitting ใน <code class="highlighter-rouge">esbuild</code> ก็ยังอยู่ในขั้น WIP ทำให้กว่าเราจะนำ <code class="highlighter-rouge">esbuild</code> มาใช้ได้จริงก็คงอีกสักระยะหนึ่ง<!--more--></p>

<p>สำหรับแนวทางในตอนนี้ที่จะถอด <code class="highlighter-rouge">Webpack</code> ออกก็คงต้องหันไปพึ่ง <code class="highlighter-rouge">Rollup</code> ก่อน เพราะโดยตัว <code class="highlighter-rouge">Rollup</code> เองมีความสามารถในการแยกโค้ดออกเป็น chunk ได้ เพียงแต่อัลกอริทึมที่ <code class="highlighter-rouge">Rollup</code> สร้างไฟล์ chunk ออกมาจะอยู่ในรูปแบบ <code class="highlighter-rouge">[name]-[hash].js</code> ซึ่ง hash ที่ออกมานั้นเข้ารหัส SHA256 แต่จะตัดเอาเฉพาะ 8 ตัวแรกเท่านั้น ซึ่งถ้านำไปงานร่วมกับ <code class="highlighter-rouge">Sprockets</code> เมื่อจะนำไปโปรดักชันจริงจะเกิดปัญหาการที่ <code class="highlighter-rouge">Sprockets</code> จะทำการ fingerprint และใส่ <code class="highlighter-rouge">hash</code> ต่อเข้าไปอีกทำให้ไม่สามารถใช้งานได้จริงในตอนนี้</p>

<p>ยกตัวอย่างโค้ดใน <code class="highlighter-rouge">application.js</code> ที่มีการเรียกใช้ dynamic import ไฟล์ <code class="highlighter-rouge">awesome.js</code> ดังโค้ดด้านล่าง</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// application.js</span>
<span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">showAwesomeThing</span> <span class="p">()</span> <span class="p">{</span>
  <span class="k">import</span><span class="p">(</span><span class="dl">"</span><span class="s2">./awesome</span><span class="dl">"</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// awesome.js</span>
<span class="k">import</span> <span class="nx">ConfettiGenerator</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">confetti-js</span><span class="dl">"</span>
<span class="kd">const</span> <span class="nx">element</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="dl">"</span><span class="s2">my-canvas</span><span class="dl">"</span><span class="p">)</span>
<span class="kd">const</span> <span class="nx">settings</span> <span class="o">=</span> <span class="p">{</span> <span class="na">target</span><span class="p">:</span> <span class="nx">element</span> <span class="p">}</span>
<span class="kd">const</span> <span class="nx">confetti</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ConfettiGenerator</span><span class="p">(</span><span class="nx">settings</span><span class="p">)</span>
<span class="nx">confetti</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
</code></pre></div></div>

<p>เมื่อใช้ <code class="highlighter-rouge">Rollup</code> ในการมัดรวมไฟล์ เราจะได้ไฟล์ออกมาเป็น 2 ไฟล์คือ</p>
<ol>
  <li>
    <p>application.js โดย <code class="highlighter-rouge">Rollup</code> จะทำการแก้ไขการ import ให้เรานิดหน่อยโดยมี hash ติดเข้าไปในไฟล์ที่จะนำเข้าด้วย</p>

    <div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">// application.js</span>
 <span class="k">export</span> <span class="k">default</span> <span class="kd">function</span> <span class="nx">showAwesomeThing</span> <span class="p">()</span> <span class="p">{</span>
   <span class="k">import</span><span class="p">(</span><span class="dl">"</span><span class="s2">./awesome-2febdb23</span><span class="dl">"</span><span class="p">)</span>
 <span class="p">}</span>
</code></pre></div>    </div>
  </li>
  <li>
    <p>awesome-2febdb23.js ซึ่งจะมี hash ตามหลังชื่อไฟล์ด้วย</p>
  </li>
</ol>

<p>และจากที่ได้เกริ่นไว้ข้างต้นว่าเมื่อจะ compile ไปใช้บนโปรดักชันจริง <code class="highlighter-rouge">Sprockets</code> ก็จะใส่ fingerprint ตามหลังชื่อไฟล์เข้าไปด้วย ทำให้ไฟล์ <code class="highlighter-rouge">awesome</code> ของเรากลายเป็น <code class="highlighter-rouge">awesome-2febdb23-aca9a2f0c2f4e33486f15c94e3b7901a05e59f7f4f368df17f4adfa3608d3dde.js</code> แต่ในไฟล์ <code class="highlighter-rouge">application</code> ยังคงเรียก <code class="highlighter-rouge">import("./awesome-2febdb23")</code> นั้นเป็นสาเหตุที่ทำให้โปรแกรมทำงานไม่ถูกต้อง</p>

<p>ด้วยความโชคดีที่มีคนเจอปัญหานี้เช่นกันเมื่อใช้ <code class="highlighter-rouge">Sprocket</code> จึงได้มีคน pull request เพื่อจะทำให้ <code class="highlighter-rouge">Sprockets</code> ไม่ต้องสนใจไฟล์ที่มี fingerprint ที่ถูกต้องอยู่แล้ว<a href="https://github.com/rails/sprockets/pull/714">ตามนี้</a> แต่ fingerprint ที่ถูกต้องนั้นก็คือต้องเข้ารหัส SHA256 ถึงแม้ว่า <code class="highlighter-rouge">Rollup</code> จะใช้ ​SHA256 เช่นกัน แต่จะมีการตัดขนาดเอาแค่ 8 ตัวแรกเท่านั้นทำให้ <code class="highlighter-rouge">Sprockets</code> มองว่านั้นไม่ใช่ fingerprint ที่ถูกต้อง</p>

<p>ดังนั้นสิ่งที่เราต้องหาทางแก้ไข คือ ทำอย่างไรก็ได้ให้ <code class="highlighter-rouge">Rollup</code> สามารถสร้างไฟล์ chunk ที่มี hash ที่ถูกต้อง โดยถ้าเข้าไปดูที่โค้ดจะพบว่าในส่วนของ<a href="https://github.com/rollup/rollup/blob/master/src/Chunk.ts#L880">การสร้าง chunk</a> จะมีโค้ด substr อยู่นั้นเอง เราก็แก้ไขโค้ดตรงนี้ หรือไม่ก็ใช้วิธีการเพิ่ม option เข้าไปในการ build ซึ่งผมก็ได้เลือกใช้วิธีการเพิ่ม option เข้าไปดีกว่า เพราะมันน่าจะยืดหยุ่นกว่า<a href="https://github.com/karn18/rollup">ตามนี้</a>
โดยสิ่งที่ได้ทำเพิ่มเข้าไปก็เป็นการเพิ่ม option ที่ชื่อ <code class="highlighter-rouge">chunkHashLength</code> เพื่อใช้กำหนดขนาดของ hash ที่ออกมามามีการสร้างไฟล์ chunk</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nx">resolve</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rollup/plugin-node-resolve</span><span class="dl">"</span>
<span class="k">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="na">input</span><span class="p">:</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">src/main.js</span><span class="dl">"</span> <span class="p">],</span>
  <span class="na">output</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">dir</span><span class="p">:</span> <span class="dl">"</span><span class="s2">dist</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">format</span><span class="p">:</span> <span class="dl">"</span><span class="s2">es</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">chunkFileNames</span><span class="p">:</span> <span class="dl">'</span><span class="s1">[name].[hash].js</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">chunkHashLength</span><span class="p">:</span> <span class="mi">64</span>
  <span class="p">},</span>
  <span class="na">plugins</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">resolve</span><span class="p">()</span>
  <span class="p">]</span>
<span class="p">}</span>
</code></pre></div></div>

<p>จากนั้นเราก็ใช้ <code class="highlighter-rouge">Rollup</code> ที่ได้รับการเพิ่มเติม option และก็เรียกใช้ <code class="highlighter-rouge">assets:precompile</code> และรันโปรแกรมแบบโปรดักชันตามปกติได้เลย</p>

<p><img src="/images/posts/2021/rails-rollup-dynamic-import/web-production.png" alt="web-production" width="800px" />
<em>dynamic import with Rollup</em></p>

<p>สำหรับในตอนนี้การใช้ workaround นี้ก็น่าจะตอบโจทย์ของเราในการที่จะใช้ dynamic import โดยไม่ต้องพึ่ง <code class="highlighter-rouge">Webpack</code> อีกต่อไปได้แล้ว เดี่ยวถ้ามีแนวทางอะไรดีๆ เกี่ยวกับการถอด <code class="highlighter-rouge">Webpack</code> ออกจะเอามาเล่าให้ฟังกันอีกทีนะครับ Bye 👋</p>

<h2 id="references">References</h2>
<ul>
  <li><a href="https://github.com/rails/jsbundling-rails">jsbundling</a></li>
  <li><a href="https://rollupjs.org/">Rollup</a></li>
  <li><a href="https://github.com/rails/sprockets/">Sprockets</a></li>
  <li><a href="https://github.com/karn18/rollup">Rollup ที่ fork ออกมาและเพิ่มเติม option</a></li>
</ul>

</main>

    </main>
  </body>
</html>
