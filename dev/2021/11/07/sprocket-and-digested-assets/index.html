<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/png" href="/images/favicon.png">

<title>Sprocket กับไฟล์ assets ที่เข้ารหัสไว้แล้ว | KT</title>

<meta name="description" content="My personal blog. Interesting in Ruby, Rails and more." />
<!-- Begin Bridgetown SEO tag v5.0.0 -->
<title>Sprocket กับไฟล์ assets ที่เข้ารหัสไว้แล้ว | KT</title>
<meta property="og:title" content="Sprocket กับไฟล์ assets ที่เข้ารหัสไว้แล้ว" />
<meta name="author" content="Karn" />
<meta property="og:locale" content="th" />
<meta name="description" content="เมื่อไฟล์ assets ที่ได้จาก chunk name ได้ทำการ digested ไว้แล้ว Sprocket จะจัดการได้อย่างไร" />
<meta property="og:description" content="เมื่อไฟล์ assets ที่ได้จาก chunk name ได้ทำการ digested ไว้แล้ว Sprocket จะจัดการได้อย่างไร" />
<link rel="canonical" href="https://karn18.github.io/dev/2021/11/07/sprocket-and-digested-assets/" />
<meta property="og:url" content="https://karn18.github.io/dev/2021/11/07/sprocket-and-digested-assets/" />
<meta property="og:site_name" content="KT" />
<meta property="og:image" content="https://karn18.github.io/images/posts/2021/sprocket-and-digested-assets/cover.png" />
<meta property="og:image:height" content="800" />
<meta property="og:image:width" content="1200" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-11-07T21:53:00+07:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://karn18.github.io/images/posts/2021/sprocket-and-digested-assets/cover.png" />
<meta property="twitter:title" content="Sprocket กับไฟล์ assets ที่เข้ารหัสไว้แล้ว" />
<!-- End Bridgetown SEO tag -->

<link rel="stylesheet" href="/_bridgetown/static/index.3VTW5G7Q.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script type="module">
  import 'https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js';
</script>
<script defer data-domain="karn18.github.io" src="https://analytics.karn.work/js/plausible.js"></script>
<script src="/_bridgetown/static/index.QYWZG4PN.js" defer></script>


  </head>
  <body class="post ">
    <nav>
  <ul>
    <li><a href="/">Home</a></li>
    
    
  </ul>
</nav>

    <main>
      <main data-controller="lightbox">
  <h1>Sprocket กับไฟล์ assets ที่เข้ารหัสไว้แล้ว</h1>

  <p>แม้ว่า <strong>Rails</strong> จะอัพเดตเป็นเวอร์ชัน 7 แล้วแต่ <strong>Sprocket</strong> ก็ถือเป็นอีกหนึ่งไลบราลีที่ยังคงผูกอยู่กับ <strong>Rails</strong> เพื่อใช้ในการจัดการคอมไฟล์ และดูแลจัดการ assets ต่างๆ ด้วย ยิ่งในระดับโปรดักชันแล้ว <strong>Sprocket</strong> จะช่วยทำ fingering ไฟล์ assets ต่างๆ เพื่อใช้สำหรับ caching อีกด้วย<!--more--></p>

<p>และจากบทความเรื่อง<a href="/dev/2021/08/18/using-importmap-on-rails-6/">Rails+Rollup+Dynamic Import</a> เราก็มีการพูดถึงการใช้ <strong>Dynamic Import</strong> ซึ่งก็พยายามแก้ไข <strong>Rollup</strong> ให้สร้าง fingerprint ด้วยการเข้ารหัสผ่านอัลกอริทึม SHA256 เพื่อนำไปใช้งานใน <strong>Rails</strong> แทนที่ <strong>Webpack</strong> ให้ได้</p>

<p>แต่นั้นก็ดูเป็นแค่วิธีการแก้ไขเฉพาะหน้าเท่านั้น เพราะดูเหมือนว่า JS Bundling แต่ละตัวก็เลือกอัลกอริทึมที่แตกต่างกัน และมีแนวทางพัฒนาที่แตกต่างกัน ทำให้การแก้ไขดังกล่าวอาจจะไม่ถูกยอมรับ และไม่ถูก PR เข้ากับรีโปของโค้ดหลักก็ได้ เพราะด้วยความที่มีคนเจอปัญหาเช่นเดียวกัน เลยทำให้เกิด <a href="https://github.com/rails/sprockets/pull/714">PR</a> ที่จะตรวจสอบไฟล์ assets ถ้าหากไฟล์ใดมีการเข้ารหัสถูกต้องตามอัลกอรีทึมที่ถูกต้องแล้ว เช่น MD5, SHA1, SHA256 เป็นต้น ก็จะไม่จำเป็นต้อง fingering ซ้ำเข้าไปในชื่อไฟล์</p>

<p>สำหรับอัพเดตล่าสุด คือในส่วนของ <a href="https://github.com/rails/sprockets/commit/3d1171d8df151547cf160f393a7a09184abc19b5">PR</a> ที่จะทำการตรวจสอบไฟล์ assets และพบว่ามีรูปแบบ <code class="highlighter-rouge">[hash].digested.[ext]</code> ก็จะไม่ทำการ fingering ไฟล์ซ้ำเข้าไปด้วย ซึ่งทำให้เราสามารถใช้ <strong>Rollup</strong> หรือ ​<strong>esbuild</strong> ได้เลย เพียงแต่เราอาจจะต้องแก้ไขค่ากำหนดตอนคอมไพล์ของแต่ละตัวเล็กน้อย</p>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// rollup.config.js</span>
<span class="k">export</span> <span class="k">default</span> <span class="p">{</span>
  <span class="na">input</span><span class="p">:</span> <span class="dl">'</span><span class="s1">app/javascript/application.js</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">output</span><span class="p">:</span> <span class="p">{</span>
    <span class="na">dir</span><span class="p">:</span> <span class="dl">'</span><span class="s1">app/assets/builds</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">format</span><span class="p">:</span> <span class="dl">'</span><span class="s1">es</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">chunkFileNames</span><span class="p">:</span> <span class="dl">'</span><span class="s1">[name]-[hash].digested.js</span><span class="dl">'</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<div class="language-javascript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// esbuild.js</span>
<span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">esbuild</span><span class="dl">'</span><span class="p">).</span><span class="nx">build</span><span class="p">({</span>
  <span class="na">entryPoints</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">app/javascript/application.js</span><span class="dl">'</span><span class="p">],</span>
  <span class="na">bundle</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">outdir</span><span class="p">:</span> <span class="dl">'</span><span class="s1">app/assets/builds</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">splitting</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
  <span class="na">format</span><span class="p">:</span> <span class="dl">'</span><span class="s1">esm</span><span class="dl">'</span><span class="p">,</span>
  <span class="na">chunkNames</span><span class="p">:</span> <span class="dl">'</span><span class="s1">[name]-[hash].digested</span><span class="dl">'</span><span class="p">,</span>
<span class="p">})</span>
</code></pre></div></div>

<h2 id="references">References</h2>
<ul>
  <li><a href="https://github.com/rails/sprockets/pull/714">Do not fingerprint if filename contains a valid digest #714</a></li>
  <li><a href="https://github.com/rails/sprockets/pull/718">Improve detection of files already digested #718</a></li>
  <li><a href="https://esbuild.github.io/api/#chunk-names">esbuild#chunk-names</a></li>
  <li><a href="https://rollupjs.org/guide/en/#outputchunkfilenames">rollup#outputchunkfilenames</a></li>
</ul>

</main>

    </main>
  </body>
</html>
