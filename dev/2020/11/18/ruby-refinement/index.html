<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/png" href="/images/favicon.png">

<title>Ruby Refinement | KT</title>

<meta name="description" content="Write an awesome description for your new site here. It will appear in your document head meta (for Google search results) and in your feed.xml site description." />

<link rel="stylesheet" href="/_bridgetown/static/index.MFT3TNYN.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script type="module">
  import 'https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js';
</script>
<script defer data-domain="karn18.github.io" src="https://analytics.karn.work/js/plausible.js"></script>
<script src="/_bridgetown/static/index.TU2OTUPV.js" defer></script>


  </head>
  <body class="post ">
    <nav>
  <ul>
    <li><a href="/">Home</a></li>
    
    
  </ul>
</nav>

    <main>
      <main data-controller="lightbox">
  <h1>Ruby Refinement</h1>

  <p>เป็นที่รู้กันดีว่า <strong>Ruby</strong> ถูกออกมาแบบมาด้วยหลักการ <strong>Open/Closed</strong> ซึ่งก็ทำให้เราสามารถที่จะทำ <strong>Monkey Patching</strong> ให้กับคลาสหรือโมดูลได้ง่ายดาย แต่อย่างไรก็ตาม <strong>Monkey Patching</strong> ก็เป็นดาบสองคม<!--more--> เพราะการ patch จะส่งผลต่อทุกๆ instance ของคลาส ซึ่งถ้าเป็นการเพิ่มเมธอดใหม่ก็ดูจะไม่กระทบอะไรเท่าไหร่ แต่ถ้าเป็นการ override เมธอดเดิมที่มีอยู่ ก็จะทำให้เกิดบั๊คกับโค้ดเราได้</p>

<h2 id="messagerb">message.rb</h2>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Message</span>
  <span class="k">def</span> <span class="nf">initailize</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="vi">@message</span> <span class="o">=</span> <span class="n">message</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">print</span>
    <span class="nb">puts</span> <span class="vi">@message</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="patched_messagerb-monkey-patching">patched_message.rb (Monkey Patching)</h2>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Message</span>
  <span class="k">def</span> <span class="nf">print</span>
    <span class="nb">puts</span> <span class="s2">"[Patched]: </span><span class="si">#{</span><span class="vi">@message</span><span class="si">}</span><span class="s2">"</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="apprb-before-patch">app.rb (Before Patch)</h2>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require_relative</span> <span class="s1">'./message'</span>

<span class="n">msg</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">new</span> <span class="s2">"Great Day"</span>
<span class="n">msg</span><span class="p">.</span><span class="nf">print</span> <span class="c1"># --&gt; Great Day</span>
<span class="n">msg</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'Awesome Day'</span><span class="p">)</span>
<span class="n">msg</span><span class="p">.</span><span class="nf">print</span> <span class="c1"># --&gt; Awesome Day</span>
</code></pre></div></div>

<h2 id="apprb-after-patch">app.rb (After Patch)</h2>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require_relative</span> <span class="s1">'./message'</span>
<span class="nb">require_relative</span> <span class="s1">'./patched_message'</span>

<span class="n">msg</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">new</span> <span class="s2">"Great Day"</span> 
<span class="n">msg</span><span class="p">.</span><span class="nf">print</span> <span class="c1"># --&gt; [Patched]: Great Day</span>
<span class="n">msg</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'Awesome Day'</span><span class="p">)</span>
<span class="n">msg</span><span class="p">.</span><span class="nf">print</span> <span class="c1"># --&gt; [Patched]: Awesome Day</span>
</code></pre></div></div>

<blockquote>
  <p>ทันที่ที่เรียก Monkey Patching การแสดงผลของทุกๆ instance ก็จะเปลี่ยนไปเมื่อเรียกใช้ print</p>
</blockquote>

<p>ที่นี้แหละ <strong>Refinement</strong> จึงได้กลายมาเป็นพระเอก ที่จะเข้ามาแก้ไขปัญหาข้างต้น โดย <strong>Refinement</strong> จะคล้ายๆ กับ <strong>Moneky Patching</strong> แต่จะส่งผลกระทบกับโค้ดที่มีเรียกใช้งานเท่านั้น หรืออยู่ภายใต้ scope ที่เราต้องการนั้นเอง</p>

<h2 id="refined_messagerb">refined_message.rb</h2>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">RefinedMessage</span>
  <span class="n">refine</span> <span class="no">Message</span> <span class="k">do</span>
    <span class="k">def</span> <span class="nf">print</span>
      <span class="nb">puts</span> <span class="s2">"[Refined]: </span><span class="si">#{</span><span class="vi">@message</span><span class="si">}</span><span class="s2">"</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>
<blockquote>
  <p>การนิยาม refinement ให้กับคลาสใดๆ จะต้องอยู่ภายใต้โมดูล</p>
</blockquote>

<h2 id="apprb-using-refinement">app.rb (Using Refinement)</h2>
<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">require_relative</span> <span class="s1">'./message'</span>
<span class="nb">require_relative</span> <span class="s1">'./refinement_message.rb'</span>

<span class="n">msg</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'Great Day'</span><span class="p">)</span>
<span class="n">msg</span><span class="p">.</span><span class="nf">print</span> <span class="c1"># --&gt; Great Day</span>

<span class="n">using</span> <span class="no">RefinedMessage</span>
<span class="n">msg</span> <span class="o">=</span> <span class="no">Message</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="s1">'Awesome Day'</span><span class="p">)</span>
<span class="n">msg</span><span class="p">.</span><span class="nf">print</span> <span class="c1"># --&gt; [Patched]: Awesome Day</span>
</code></pre></div></div>

<blockquote>
  <p>การใช้งาน refinement ก็จะใช้ <code class="highlighter-rouge">using</code> ตามด้วยโมดูลที่เราได้นิยาม refinement เอาไว้</p>
</blockquote>

<p>สำหรับการใช้ <strong>Refinement</strong> ก็ประมาณนี้ก็จะช่วยให้เราเพิ่มความสามารถให้กับคลาสเดิมของเราได้ โดยที่ไม่ส่งผลกระทบกับโค้ดเดิมที่เราใช้งานอยู่</p>

<h2 id="references">References</h2>
<ul>
  <li><a href="https://docs.ruby-lang.org/en/2.4.0/syntax/refinements_rdoc.html">Refinement</a></li>
  <li><a href="https://rollout.io/blog/ruby-refinements/">ruby-refinement</a></li>
</ul>

</main>

    </main>
  </body>
</html>
