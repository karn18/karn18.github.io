<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/png" href="/images/favicon.png">

<title>Svelte join forces with Rails and Turbo | KT</title>

<meta name="description" content="Write an awesome description for your new site here. It will appear in your document head meta (for Google search results) and in your feed.xml site description." />

<link rel="stylesheet" href="/karn.work/_bridgetown/static/index.KTVN5CND.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script type="module">
  import 'https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js';
</script>
<script src="/karn.work/_bridgetown/static/index.OWF3DFHJ.js" defer></script>


  </head>
  <body class="post ">
    <nav>
  <ul>
    <li><a href="/karn.work/">Home</a></li>
    
    
  </ul>
</nav>

    <main>
      <main data-controller="lightbox">
  <h1>Svelte join forces with Rails and Turbo</h1>

  <p>เริ่มต้นมันเกิดจากที่ว่าอยากทดลองใช้งาน <strong>Svelte</strong> ดู แต่ก็อยากใช้ <strong>Rails</strong> เป็น server แทนที่จะใช้ <strong>SvelteKit</strong> เลยต้องหาแนวทางที่จะทำงานร่วมกัน ด้วยที่ปกติใช้ <strong>Stimulus</strong> ก็เลยได้ไอเดียของการ register คอนโทรลเลอร์ที่ใช้งานเก็บไว้ และถ้าจะใช้งานคอนโทรลเลอร์ตัวไหนกับ HTML ใดก็จะผูกกันด้วย <code class="highlighter-rouge">data-attributes</code> ดังนั้นเราจึงได้พัฒนา <strong>Registry</strong> ง่ายๆ ขึ้นมาทดสอบกัน</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// app/javscript/application.js</span>
<span class="k">import</span> <span class="dl">"</span><span class="s2">@hotwired/turbo-rails</span><span class="dl">"</span>

<span class="k">import</span> <span class="p">{</span> <span class="nx">Registry</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">./svelte/registry</span><span class="dl">"</span>
<span class="k">import</span> <span class="nx">App</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./components/App.svelte</span><span class="dl">'</span>
<span class="k">import</span> <span class="nx">About</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./components/About.svelte</span><span class="dl">'</span>

<span class="kd">const</span> <span class="nx">registry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Registry</span><span class="p">()</span>
<span class="nx">registry</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
<span class="nx">registry</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="dl">"</span><span class="s2">main</span><span class="dl">"</span><span class="p">,</span> <span class="nx">App</span><span class="p">)</span>
<span class="nx">registry</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="dl">"</span><span class="s2">about</span><span class="dl">"</span><span class="p">,</span> <span class="nx">About</span><span class="p">)</span>
</code></pre></div></div>

<p>สำหรับหน้าที่ของ <strong>Registry</strong> จะทำหน้าที่เก็บชุดข้อมูลชื่อ และคอมโพเนนต์ของ <strong>Svelte</strong> และเมื่อโค้ดสั่งให้ทำงานจะทำการค้นหา <code class="highlighter-rouge">data-attributes</code> ที่ตรงตามเงื่อนไข ซึ่งเราได้กำหนดให้เป็น <code class="highlighter-rouge">data-svelte-component={name}</code> และทำการ render คอมโพเนนต์เข้าไปยัง element นั้น</p>

<p>จากโค้ดข้างต้นจะเห็นว่า <strong>Registry</strong> ได้ลงทะเบียนคอมโพเนนต์ 2 ตัวคือ</p>
<ol>
  <li><strong>App</strong> ซึ่งจะทำการผูกกับชื่อ main</li>
  <li><strong>About</strong> ซึ่งจะทำการผูกกับชื่อ about</li>
</ol>

<p>เพื่อความสะดวกในการใช้งาน เราจะได้สร้าง <strong>tag helper</strong> ที่ชื่อ <code class="highlighter-rouge">svelte_component</code> ขึ้นมาตอนใช้งานด้วย ทำให้เวลาที่ต้องการ render คอมโพเนนต์บนหน้า HTML จะเรียกผ่าน <code class="highlighter-rouge">svelte_component</code> ดังแสดงในตัวอย่างด้านล่าง</p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">module</span> <span class="nn">SvelteHelper</span>
  <span class="k">def</span> <span class="nf">svelte_component</span><span class="p">(</span><span class="n">identifier</span><span class="p">,</span> <span class="n">props</span> <span class="o">=</span> <span class="p">{},</span> <span class="ss">tag_name: </span><span class="s2">"div"</span><span class="p">)</span>
    <span class="n">data_attr</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">svelte_component: </span><span class="n">identifier</span> <span class="p">}</span>
    <span class="n">data_attr</span> <span class="o">=</span> <span class="n">data_attr</span><span class="p">.</span><span class="nf">merge</span><span class="p">(</span><span class="ss">svelte_props: </span><span class="n">props</span><span class="p">)</span> <span class="k">unless</span> <span class="n">props</span><span class="p">.</span><span class="nf">empty?</span>

    <span class="n">tag</span><span class="p">.</span><span class="nf">__send__</span><span class="p">(</span><span class="n">tag_name</span><span class="p">,</span> <span class="ss">data: </span><span class="n">data_attr</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="no">ActionView</span><span class="o">::</span><span class="no">Base</span><span class="p">.</span><span class="nf">extend</span> <span class="no">SvelteHelper</span>
</code></pre></div></div>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- app/views/home/index.html --&gt;</span>
<span class="nt">&lt;main</span> <span class="na">class=</span><span class="s">"w-full md:w-3/5 lg:w-2/5 mx-auto"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;</span><span class="err">%=</span> <span class="na">link_to</span> <span class="err">"</span><span class="na">about</span><span class="err">",</span> <span class="na">:about</span><span class="err">,</span> <span class="na">class:</span> <span class="err">"</span><span class="na">inline-flex</span> <span class="na">rounded-full</span> <span class="na">border</span> <span class="na">items-center</span> <span class="na">h-9</span> <span class="na">mt-6</span> <span class="na">px-3</span><span class="err">"</span> <span class="err">%</span><span class="nt">&gt;</span>

  <span class="nt">&lt;</span><span class="err">%=</span> <span class="na">svelte_component</span> <span class="err">"</span><span class="na">main</span><span class="err">"</span> <span class="err">%</span><span class="nt">&gt;</span>
<span class="nt">&lt;/main&gt;</span>

</code></pre></div></div>

<h2 id="ทดสอบการทำงาน">ทดสอบการทำงาน</h2>

<p><img src="/images/posts/2022/svelte-join-forces-with-rails-and-turbo/home.png" alt="" width="600px" />
<em>Home</em></p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">&lt;</span><span class="nx">script</span><span class="o">&gt;</span>
  <span class="k">import</span> <span class="p">{</span> <span class="nx">onMount</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">svelte</span><span class="dl">"</span>
  <span class="k">import</span> <span class="p">{</span> <span class="kd">get</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@rails/request.js</span><span class="dl">"</span>
  <span class="kd">let</span> <span class="nx">books</span> <span class="o">=</span> <span class="p">[]</span>

  <span class="k">async</span> <span class="kd">function</span> <span class="nx">getBooks</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="kd">get</span><span class="p">(</span><span class="dl">'</span><span class="s1">http://localhost:3000/api/books.json</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">responseKind</span><span class="p">:</span> <span class="dl">"</span><span class="s2">json</span><span class="dl">"</span> <span class="p">})</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">ok</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">return</span> <span class="nx">response</span><span class="p">.</span><span class="nx">json</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="kc">null</span>
  <span class="p">}</span>

  <span class="nx">onMount</span><span class="p">(</span><span class="k">async</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">books</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">getBooks</span><span class="p">()</span>
  <span class="p">})</span>
<span class="o">&lt;</span><span class="sr">/script</span><span class="err">&gt;
</span>
<span class="o">&lt;</span><span class="nx">h1</span> <span class="kd">class</span><span class="o">=</span><span class="dl">"</span><span class="s2">font-bold text-3xl pt-8</span><span class="dl">"</span><span class="o">&gt;</span><span class="nx">Books</span><span class="o">&lt;</span><span class="sr">/h1</span><span class="err">&gt;
</span><span class="p">{</span><span class="err">#</span><span class="k">if</span> <span class="nx">books</span><span class="p">}</span>
<span class="o">&lt;</span><span class="nx">ul</span> <span class="kd">class</span><span class="o">=</span><span class="dl">"</span><span class="s2">bg-slate-50 p-4 my-4 text-sm leading-6</span><span class="dl">"</span><span class="o">&gt;</span>
  <span class="p">{</span><span class="err">#</span><span class="nx">each</span> <span class="nx">books</span> <span class="k">as</span> <span class="nx">book</span><span class="p">}</span>
    <span class="o">&lt;</span><span class="nx">li</span><span class="o">&gt;</span>
      <span class="o">&lt;</span><span class="nx">a</span> <span class="nx">href</span><span class="o">=</span><span class="p">{</span><span class="nx">book</span><span class="p">.</span><span class="nx">url</span><span class="p">}</span> <span class="kd">class</span><span class="o">=</span><span class="dl">"</span><span class="s2">group flex rounded-md m-2 p-3 bg-white ring-1 ring-slate-200 shadow-sm</span><span class="dl">"</span><span class="o">&gt;</span>
        <span class="p">...</span>
      <span class="o">&lt;</span><span class="sr">/a</span><span class="err">&gt;
</span>    <span class="o">&lt;</span><span class="sr">/li</span><span class="err">&gt;
</span>  <span class="p">{</span><span class="sr">/each</span><span class="err">}
</span><span class="o">&lt;</span><span class="sr">/ul</span><span class="err">&gt;
</span><span class="p">{</span><span class="sr">/if</span><span class="err">}
</span></code></pre></div></div>

<p><img src="/images/posts/2022/svelte-join-forces-with-rails-and-turbo/generated_html.png" alt="" width="600px" />
<em>HTML ที่ถูกสร้างจาก Svelte</em></p>

<p><img src="/images/posts/2022/svelte-join-forces-with-rails-and-turbo/about.png" alt="" width="600px" />
<em>About</em></p>

<blockquote>
  <p>ทั้งนี้ <strong>Registry</strong> ยังรองรับการทำงานร่วมกับ Turbo อีกด้วย ทำให้เวลาที่มีการเปลี่ยนหน้าตัว browser จะไม่ต้องโหลด resource ใหม่ทั้งหมด</p>
</blockquote>

<p>Demo: <a href="https://svelte.karn.work/home/index">https://svelte.karn.work/home/index</a></p>

</main>

    </main>
  </body>
</html>
