<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/png" href="/images/favicon.png">

<title>รับมือการใช้ Yarn Pnp บน Rails | KT</title>

<meta name="description" content="My personal blog. Interesting in Ruby, Rails and more." />
<!-- Begin Bridgetown SEO tag v5.0.0 -->
<title>รับมือการใช้ Yarn Pnp บน Rails | KT</title>
<meta property="og:title" content="รับมือการใช้ Yarn Pnp บน Rails" />
<meta name="author" content="Karn" />
<meta property="og:locale" content="th" />
<meta name="description" content="อยู่ๆ เมื่อเราอัพเดต yarn จากเวอร์ชัน 1.x เป็นเวอร์ชัน 2.x หรือ 3.x ทำให้โปรเจ็ค Rails ของเราไม่สามารถคอมไพล์หรือบันเดิลโค้ดได้อย่างเดิม นั้นเป็นเพราะอะไรมาลองติดตามกันดู" />
<meta property="og:description" content="อยู่ๆ เมื่อเราอัพเดต yarn จากเวอร์ชัน 1.x เป็นเวอร์ชัน 2.x หรือ 3.x ทำให้โปรเจ็ค Rails ของเราไม่สามารถคอมไพล์หรือบันเดิลโค้ดได้อย่างเดิม นั้นเป็นเพราะอะไรมาลองติดตามกันดู" />
<link rel="canonical" href="https://karn18.github.io/dev/2022/07/03/how-to-handle-yarn-pnp-in-rails/" />
<meta property="og:url" content="https://karn18.github.io/dev/2022/07/03/how-to-handle-yarn-pnp-in-rails/" />
<meta property="og:site_name" content="KT" />
<meta property="og:image" content="https://surfup.karn.work/covers/835ddb9c80/48d96cfc1b.png" />
<meta property="og:image:height" content="630" />
<meta property="og:image:width" content="1200" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-07-03T20:13:00+07:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="https://surfup.karn.work/covers/835ddb9c80/48d96cfc1b.png" />
<meta property="twitter:title" content="รับมือการใช้ Yarn Pnp บน Rails" />
<!-- End Bridgetown SEO tag -->

<link rel="stylesheet" href="/_bridgetown/static/index.ZZO5N2GR.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script type="module">
  import 'https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js';
</script>
<script defer data-domain="karn18.github.io" src="https://analytics.karn.work/js/plausible.js"></script>
<script src="/_bridgetown/static/index.QYWZG4PN.js" defer></script>


  </head>
  <body class="post ">
    <nav>
  <ul>
    <li><a href="/">Home</a></li>
    
    
  </ul>
</nav>

    <main>
      <main data-controller="lightbox">
  <h1>รับมือการใช้ Yarn Pnp บน Rails</h1>

  <p><a href="https://yarnpkg.com/features/pnp#the-node_modules-problem">ปัญหาของ <strong>node_modules</strong></a> ทำให้ <strong>Yarn</strong> เองก็ได้รับการพัฒนาการกลไกการจัดเก็บ dependencies ต่างๆ ให้ดีขึ้น ซึ่งถูกเรียกว่า <strong><a href="https://yarnpkg.com/features/pnp">Plug’n Play</a></strong> โดยเราจะได้ใช้งานกลไกนี้เป็นค่าพื้นฐานเมื่อติดตั้งเวอร์ชันมากกว่า 2.0 ขึ้นไป</p>

<p>เอ๊ะ! แล้วกลไก <strong>Plug’n Play</strong> มันกระทบกับโปรเจ็ค <strong>Rails</strong> ของเราอย่างไร สำหรับบทความนี้เราจะโฟกัสกับ <strong>Rails 7</strong> ที่ใช้งานร่วมกับ <strong>jsbundling-rails</strong> โดยเลือกใช้ <strong>esbuild</strong> เป็นตัวคอมไพล์และบันเดิลโค้ด</p>

<p>ถ้าเราลองสร้างโปรเจ็คง่ายๆ ที่แค่ใช้ ​<strong>Stimulus</strong> และ <strong>Turbo</strong> เพียงเท่านั้นตามคำสั่ง <code class="highlighter-rouge">rails new myapp -j esbuild -a propshaft</code> จากนั้นก็ทำการคอมไพล์ JavaScript ด้วยคำสั่ง <code class="highlighter-rouge">yarn run build</code> ปรากฏว่าเจ้า <strong>esbuild</strong> จะพ่น error ออกมาว่าหา <strong>@hotwired/turbo-rails</strong> และ <strong>@hotwired/stimulus</strong> ไม่พบ</p>

<p><img src="/images/posts/2022/how-to-handle-yarn-pnp-in-rails/error.png" alt="" width="600px" />
<em>Error</em></p>

<p>เพราะอะไรกันถึงเป็นแบบนี้ ทั้งๆ ที่ก่อนหน้านี้เราก็ทำเหมือนเดิมทุกอย่าง เมื่อลองไปตรวจสอบโฟลเดอร์ของโปรเจ็คดู ก็พบว่าโฟลเดอร์ <strong>node_modules</strong> ที่ควรจะมีอยู่หายไป นั้นเป็นเพราะกลไก ​<strong>Plug’n Play</strong> จะไม่สร้างโฟลเดอร์ <strong>node_modules</strong> เก็บไว้ในโปรเจ็คเราอีกต่อไป จึงส่งผลให้ <strong>esbuild</strong> ไม่สามารถค้นหา dependencies ที่ใช้เจอ</p>

<p><img src="/images/posts/2022/how-to-handle-yarn-pnp-in-rails/directory.png" alt="" width="300px" />
<em>Project Directory</em></p>

<p>จากที่ได้ทดลองหาวิธีแก้ปัญหา เราสามารถทำได้ 2 วิธี (อันนี้เท่าที่ลองเองนะครับ) คือ</p>

<ol>
  <li>
    <p>กำหนดค่า <strong>nodeLinker</strong> ใน <code class="highlighter-rouge">.yarnrc.yml</code></p>

    <p>ให้เรากำหนดค่าเป็น <code class="highlighter-rouge">nodeLinker: "node-modules"</code> และอาจรันคำสั่ง <code class="highlighter-rouge">yarn install</code> อีกครั้ง ด้วยการกำหนด <strong>nodeLiker</strong> ดังกล่าวทำให้ <strong>Yarn</strong> ทำการติดตั้ง dependencies เอาไว้ที่โฟลเดอร์ <strong>node_modules</strong> ในโปรเจ็คเราเหมือนเดิม</p>
  </li>
  <li>
    <p>ใช้ปลักอิน <a href="https://github.com/yarnpkg/berry/tree/master/packages/esbuild-plugin-pnp">esbuild-plugin-pnp</a></p>

    <p>แทนที่จะไปแก้ไขที่ตัวอย่างวิธีการนี้จะเป็นการเพิ่มเติมความสามารถให้กับ <strong>esbuild</strong> เพื่อให้ไปค้นหา dependencies จากโฟลเดอร์ที่ถูกต้องแทนการค้นหาจากโฟลเดอร์ <strong>node_modules</strong> ในโปรเจ็ค</p>

    <div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">// esbuild.js</span>
 <span class="kd">const</span> <span class="p">{</span> <span class="nx">build</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">esbuild</span><span class="dl">'</span><span class="p">)</span>
 <span class="kd">const</span> <span class="p">{</span> <span class="nx">pnpPlugin</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="dl">'</span><span class="s1">@yarnpkg/esbuild-plugin-pnp</span><span class="dl">'</span><span class="p">)</span>
  
 <span class="nx">build</span><span class="p">({</span>
   <span class="na">entryPoints</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">./app/javascript/application.js</span><span class="dl">'</span><span class="p">],</span>
   <span class="na">outdir</span><span class="p">:</span> <span class="dl">'</span><span class="s1">./app/assets/builds</span><span class="dl">'</span><span class="p">,</span>
   <span class="p">...</span>
   <span class="na">plugins</span><span class="p">:</span> <span class="p">[</span> <span class="nx">pnpPlugin</span><span class="p">()</span> <span class="p">]</span>
 <span class="p">})</span>
 <span class="p">.</span><span class="nx">then</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s2">`⚡ Build Done!!!`</span><span class="p">)</span>
 <span class="p">})</span>
 <span class="p">.</span><span class="k">catch</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="nx">process</span><span class="p">.</span><span class="nx">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
</code></pre></div>    </div>
  </li>
</ol>

<p>ไม่ว่าจะเลือกวิธีใดวิธีการหนี่งเราก็สามารถจะคอมไพล์และบันเดิลโค้ดของเราได้ตามปกติเหมือนเดิม เพียงแต่อยากจะแนะนำวิธีการที่ 2 มากกว่าวิธีการแรก</p>

</main>

    </main>
  </body>
</html>
