<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/png" href="/images/favicon.png">

<title>เปลี่ยน UJS มาเป็น Turbo | KT</title>

<meta name="description" content="My personal blog. Interesting in Ruby, Rails and more." />
<!-- Begin Bridgetown SEO tag v5.0.0 -->
<title>เปลี่ยน UJS มาเป็น Turbo | KT</title>
<meta property="og:title" content="เปลี่ยน UJS มาเป็น Turbo" />
<meta name="author" content="Karn" />
<meta property="og:locale" content="th" />
<meta name="description" content="จาก Unobtructive JavaScript หรีอ UJS ที่ใช้กันมาเนิ่นนาน เปลี่ยนมาใช้ Turbo แทนจะเป็นอย่างไรกันบ้าง" />
<meta property="og:description" content="จาก Unobtructive JavaScript หรีอ UJS ที่ใช้กันมาเนิ่นนาน เปลี่ยนมาใช้ Turbo แทนจะเป็นอย่างไรกันบ้าง" />
<link rel="canonical" href="https://karn18.github.io/dev/2022/02/15/from-ujs-to-turbo/" />
<meta property="og:url" content="https://karn18.github.io/dev/2022/02/15/from-ujs-to-turbo/" />
<meta property="og:site_name" content="KT" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-02-15T13:17:00+07:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="เปลี่ยน UJS มาเป็น Turbo" />
<!-- End Bridgetown SEO tag -->

<link rel="stylesheet" href="/_bridgetown/static/index.OJNAJA5Q.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script type="module">
  import 'https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js';
</script>
<script defer data-domain="karn18.github.io" src="https://analytics.karn.work/js/plausible.js"></script>
<script src="/_bridgetown/static/index.QYWZG4PN.js" defer></script>


  </head>
  <body class="post ">
    <nav>
  <ul>
    <li><a href="/">Home</a></li>
    
    
  </ul>
</nav>

    <main>
      <main data-controller="lightbox">
  <h1>เปลี่ยน UJS มาเป็น Turbo</h1>

  <p>ปกติแล้วในการจัดการกับ frontend ของโปรแกรมต่างๆ เราจะใช้ <strong><a href="https://guides.rubyonrails.org/working_with_javascript_in_rails.html#unobtrusive-javascript">Unobtructive JavaScript (UJS)</a></strong> ซึ่งเป็นเทคนิคที่ <strong>Rails</strong> นำเสนอขึ้นมาเพื่อใช้จัดการกับ JavaScript และ DOM ในการแสดงผล ด้วยเทคนิคดังกล่าวก็จะทำให้เราเขียนโค้ด <strong>JavaScript</strong> ที่ฝั่งหลังบ้าน และส่งไปรันที่หน้าบ้านได้</p>

<p>แต่ด้วยการมาของ <strong>Turbo</strong> ทำให้รูปแบบการแสดงผลทำได้ง่ายขึ้น และใช้การเขียน <strong>HTML</strong> ปกติแทน <strong>JavaScript</strong> ซึ่งก็ดูจะ clean กว่าเดิมมาก ดังนั้นเราจึงได้ทำการเปลี่ยนจาก <strong>UJS</strong> มาเป็น <strong>Turbo</strong> ร่วมกับ <strong>Stimulus</strong> สำหรับแนวทางการปรับเปลี่ยนสามารถศึกษาได้จาก<a href="https://github.com/hotwired/turbo-rails/blob/main/UPGRADING.md">ที่นี้</a></p>

<p>ในมุมของการปรับแก้ไขโค้ดต้องบอกเลยว่าโค้ดของ <strong>controllers</strong> และ <strong>routes</strong> ไม่ต้องปรับเปลี่ยนอะไรเลย เราสามารถใช้โค้ดเดิมได้ แต่สิ่งที่เราต้องแก้ก็มีเพียงแค่โค้ดใน <strong>views</strong> เท่านั้น ในบทความนี้จะยกตัวอย่างที่เราแก้ไขมาให้ดู โดยจะเป็นการกดปุ่มเพื่อเปิดดึงข้อมูลมาแสดงบนกล่องแสดงข้อความแบบ Modal</p>

<video controls="" playsinline="">
  <source src="/videos/turbo.mov" type="video/mp4" />
</video>

<blockquote>
  <p>‼️ ด้วยตัวอย่างทั้งสองแบบมีการใช้ CSS กันคนละตัวอาจจะมีทำให้สับสนกันบ้างนะครับ ‼️</p>
</blockquote>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- app/views/invoices/index.html (UJS) --&gt;</span>
<span class="c">&lt;!-- link_to ที่กำหนดให้ remote เป็น true --&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">link_to</span> <span class="p">[</span><span class="n">invoice</span><span class="p">,</span> <span class="s1">'info'</span><span class="p">],</span> <span class="ss">remote: </span><span class="kp">true</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;i</span> <span class="na">class=</span><span class="s">"info </span><span class="cp">&lt;%=</span> <span class="s1">'inactive'</span> <span class="k">unless</span> <span class="n">invoice</span><span class="p">.</span><span class="nf">audit_logs</span><span class="p">.</span><span class="nf">present?</span> <span class="cp">%&gt;</span><span class="s"> icon"</span><span class="nt">&gt;&lt;/i&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>

<span class="c">&lt;!-- Modal --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"ui modal"</span> <span class="na">id=</span><span class="s">"modal"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"header"</span><span class="nt">&gt;</span><span class="cp">&lt;%=</span> <span class="n">t</span><span class="p">(</span><span class="s1">'invoice.info_label'</span><span class="p">)</span> <span class="cp">%&gt;</span><span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"invoice_info_content"</span> <span class="na">class=</span><span class="s">"content"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- app/views/invoices/info.js.erb --&gt;</span>
$("#invoice_info_content").html("<span class="cp">&lt;%=</span> <span class="n">j</span> <span class="n">render</span> <span class="s1">'info'</span><span class="p">,</span> <span class="ss">invoice: </span><span class="vi">@invoice</span> <span class="cp">%&gt;</span>");
$('#invoice_info_modal').modal('show');
</code></pre></div></div>

<p>เมื่อใช้ <strong>UJS</strong> เราจะกำหนดค่า remote เป็น true ให้กับ link_to เพื่อบอกให้รู้ว่าเมื่อมีการกดปุ่มจะเรียก ajax request ไปยังหลังบ้าน และนำค่ามาแสดงซึ่งหลังบ้านเราจะเขียนเป็นโค้ด <strong>JavaScript</strong> เพื่อสั่งให้แสดง <strong>HTML</strong> ของ info และเรียกให้ Modal แสดงขึ้นมา จะสังเกตุเห็นนามสกุลของไฟล์เป็น <code class="highlighter-rouge">.js.erb</code></p>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- app/views/invoices/index.html (Turbo) --&gt;</span>
<span class="c">&lt;!-- button ที่ีกำหนดค่าด้วย stimulus --&gt;</span>
<span class="nt">&lt;button</span> <span class="na">data-action=</span><span class="s">"click-&gt;fetch#info click-&gt;modal#open"</span> <span class="na">class=</span><span class="s">"self-center"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;svg</span> <span class="na">xmlns=</span><span class="s">"http://www.w3.org/2000/svg"</span> <span class="na">class=</span><span class="s">"h-6 w-6</span><span class="cp">&lt;%=</span> <span class="s1">' text-red-400'</span> <span class="k">if</span> <span class="n">invoice</span><span class="p">.</span><span class="nf">audit_logs</span><span class="p">.</span><span class="nf">present?</span> <span class="cp">%&gt;</span><span class="s">"</span> <span class="na">fill=</span><span class="s">"none"</span> <span class="na">viewBox=</span><span class="s">"0 0 24 24"</span> <span class="na">stroke=</span><span class="s">"currentColor"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;path</span> <span class="na">stroke-linecap=</span><span class="s">"round"</span> <span class="na">stroke-linejoin=</span><span class="s">"round"</span> <span class="na">stroke-width=</span><span class="s">"2"</span> <span class="na">d=</span><span class="s">"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"</span> <span class="nt">/&gt;</span>
  <span class="nt">&lt;/svg&gt;</span>
<span class="nt">&lt;/button&gt;</span>

<span class="c">&lt;!-- Modal --&gt;</span>
<span class="nt">&lt;div</span> <span class="na">data-modal-target=</span><span class="s">"container"</span> <span class="na">data-action=</span><span class="s">"click-&gt;modal#closeBackground keyup@window-&gt;modal#closeWithKeyboard"</span> <span class="na">class=</span><span class="s">"w-screen h-screen absolute hidden z-[100]"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"modal-bg"</span> <span class="na">class=</span><span class="s">"w-screen h-screen bg-gray-100 opacity-70 absolute"</span><span class="nt">&gt;&lt;/div&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">turbo_frame_tag</span> <span class="s2">"modal"</span><span class="p">,</span> <span class="s2">"data-modal-default-content"</span><span class="p">:</span> <span class="kp">true</span> <span class="k">do</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"modal-box"</span> <span class="na">class=</span><span class="s">"w-1/3 flex flex-col gap-2 -translate-y-1/2 p-6 bg-white rounded-lg top-1/2 left-1/2 -translate-x-1/2 absolute border shadow-md"</span><span class="nt">&gt;</span>
        <span class="cp">&lt;%=</span> <span class="n">image_tag</span> <span class="s1">'default_loading.gif'</span><span class="p">,</span> <span class="ss">class: </span><span class="s2">"w-12 mx-auto"</span> <span class="cp">%&gt;</span>
      <span class="nt">&lt;/div&gt;</span> %&gt;
    <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
  <span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;!-- app/views/invoices/info.turbo_strea.erb --&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">turbo_stream</span><span class="p">.</span><span class="nf">replace</span> <span class="s2">"modal"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">turbo_frame_tag</span> <span class="s2">"modal"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">id=</span><span class="s">"modal-box"</span> <span class="na">class=</span><span class="s">"w-1/3 flex flex-col gap-2 -translate-y-1/2 p-6 bg-white rounded-lg top-1/2 left-1/2 -translate-x-1/2 absolute border shadow-md"</span><span class="nt">&gt;</span>
      ...
    <span class="nt">&lt;/div&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<p>หลังจากปรับมาใช้ <strong>Turbo</strong> แน่นอนว่าเราจะต้องใช้งานคู่กับ <strong>Stimulus</strong> ซึ่งเราใช้งาน <strong>Controller</strong> 2 ตัวร่วมกันคือ</p>

<ol>
  <li><code class="highlighter-rouge">ModalController</code> เพื่อใช้สำหรับการจัดการ Modal</li>
  <li><code class="highlighter-rouge">FetchController</code> เพื่อใช้สำหรับดึงข้อมูลจากหลังบ้านมาแสดงผ่าน <strong>TurboStream</strong></li>
</ol>

<p>ในส่วนของ Modal เราก็จะใส่ <strong>TurboFrame</strong> เพื่อใช้แสดงผลต่างๆ ที่มาจากหลังบ้านซึ่งมาในรูปของ <strong>TurboStream</strong> จะสังเกตุได้จากนามสกุลของไฟล์ที่เป็น <code class="highlighter-rouge">.turbo_stream.erb</code></p>

<p>อย่างไรก็ตามทั้ง 2 วิธีให้ผลลัพธ์ที่ไม่แตกต่างกัน แต่ <strong>Turbo</strong> จะทำให้เรารู้สึกไม่ต้องเขียนโค้ด <strong>JavaScript</strong> และทำให้เราโฟกัสที่โค้ด <strong>Ruby</strong> และโลจิกที่จะให้เกิดขึ้นมากกว่า</p>

<p>ต้องยอมรับว่าในบางโปรเจ็คการเปลี่ยน <strong>UJS</strong> มาเป็น <strong>Turbo</strong> นั้นก็คงไม่ง่าย ดังน้นเราสามารถใช้ <a href="https://mrujs.com/">MRUJS</a> ซึ่งเป็นเหมือนสะพานให้เรายังคงใช้งาน <strong>USJ</strong> ได้อยู่กับ <strong>Rails 7</strong> ซึ่งก็ได้มีโอกาสเข้าไปทดลองใช้ และสามารถใช้งานได้อย่างราบรื่นเลยทีเดียว</p>

</main>

    </main>
  </body>
</html>
