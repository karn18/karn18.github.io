<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="icon" type="image/png" href="/images/favicon.png">

<title>พรีวิว Markdown ด้วย Turbo Stream | KT</title>

<meta name="description" content="Write an awesome description for your new site here. It will appear in your document head meta (for Google search results) and in your feed.xml site description." />

<link rel="stylesheet" href="/_bridgetown/static/index.NXSPJ6K7.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/glightbox/dist/css/glightbox.min.css" />
<script type="module">
  import 'https://cdn.jsdelivr.net/gh/mcstudios/glightbox/dist/js/glightbox.min.js';
</script>
<script defer data-domain="karn18.github.io" src="https://analytics.karn.work/js/plausible.js"></script>
<script src="/_bridgetown/static/index.TU2OTUPV.js" defer></script>


  </head>
  <body class="post ">
    <nav>
  <ul>
    <li><a href="/">Home</a></li>
    
    
  </ul>
</nav>

    <main>
      <main data-controller="lightbox">
  <h1>พรีวิว Markdown ด้วย Turbo Stream</h1>

  <p>จากบทความ<a href="https://www.colby.so/posts/real-time-previews-with-stimulus-reflex">Real-time previews with Rails and StimulusReflex</a> ได้สร้างเว็บแอพพลิเคชันที่ใช้ <strong>StimulusReflex</strong> ในการแสดงพรีวิว Markdown แบบเรียลไทม์ได้อย่างยอดเยี่ยมเลยทีเดียว แถมใช้เวลาในการอัพเดต DOM ได้รวดเร็วอีกด้วย แต่ด้วยปกติผมไม่ได้ <strong>StimulusReflex</strong> ดังนั้นในบทความนี้เราจะมาเปลี่ยนมาใช้ <strong>Stimulus</strong> กับ <strong>TurboStream</strong> ที่เราคุ้นเคยกันดีกว่า ประกอบกับเคยเขียนแนวทางพัฒนาพรีวิว Markdown ไวก่อนหน้านี้แต่ตอนนั้นยังไม่ได้ใช้ <strong>TurboStream</strong> ทีในบทความ<a href="https://karn18.github.io/dev/2020/06/03/create-markdown-preview.html">ลองพัฒนา markdown preview</a></p>

<p>ในบทความนี้ผมจะใช้โค้ดจากบทความอ้างอิงเป็นหลัก แต่จะปรับโค้ดในฝั่งของ <strong>JavaScript</strong> ให้ใช้เฉพาะ <strong>Stimulus</strong> โดยจะใช้ request ไปยัง URL ในการแสดงพรีวิว และกำหนด content-type ของ respose ที่จะรับกลับมาเป็น <code class="highlighter-rouge">vnd.turbo-stream.html</code> หรือ <strong>TurboStream</strong> นั้นเอง</p>

<div class="language-js highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// app/javascript/controllers/post_controller.js</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Controller</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">@hotwired/stimulus</span><span class="dl">"</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">post</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@rails/request.js</span><span class="dl">'</span>

<span class="k">export</span> <span class="k">default</span> <span class="kd">class</span> <span class="kd">extends</span> <span class="nx">Controller</span> <span class="p">{</span>
  <span class="kd">static</span> <span class="nx">values</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">id</span><span class="p">:</span> <span class="nb">String</span>
  <span class="p">}</span>
  <span class="kd">static</span> <span class="nx">targets</span> <span class="o">=</span> <span class="p">[</span> <span class="dl">"</span><span class="s2">body</span><span class="dl">"</span><span class="p">,</span> <span class="dl">"</span><span class="s2">bodyPreview</span><span class="dl">"</span> <span class="p">]</span>

  <span class="nx">connect</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">preview</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">debounce</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">preview</span><span class="p">,</span> <span class="mi">1000</span><span class="p">).</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">preview</span><span class="p">()</span>
  <span class="p">}</span>

  <span class="k">async</span> <span class="nx">preview</span> <span class="p">()</span> <span class="p">{</span>
    <span class="k">await</span> <span class="nx">post</span><span class="p">(</span><span class="s2">`/posts/preview`</span><span class="p">,</span> <span class="p">{</span> <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">({</span> <span class="na">body</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">bodyTarget</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="na">id</span><span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">idValue</span> <span class="p">}),</span> <span class="na">responseKind</span><span class="p">:</span> <span class="dl">"</span><span class="s2">turbo-stream</span><span class="dl">"</span> <span class="p">})</span> 
  <span class="p">}</span>

  <span class="nx">debounce</span> <span class="p">(</span><span class="nx">fn</span><span class="p">,</span> <span class="nx">delay</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ที่จะแตกต่างจากของเดิมก็คือในโค้ด values จะรับ <code class="highlighter-rouge">id:String</code> เข้ามาเพื่อใช้ในการอ้างอิงกับ <strong>TurboFrame</strong> ส่วน targets จะสนใจเฉพาะ <strong>body</strong> และ <strong>bodyPreview</strong> เท่านั้น และในเมธอด <code class="highlighter-rouge">preview</code> ก็จะเรียก POST ไปยัง <code class="highlighter-rouge">/posts/preview</code> ที่รับ response กลับมาเป็น <strong>TurboStream</strong></p>

<p>ในฝั่งหลังบ้านนั้นก็จะสร้าง action <code class="highlighter-rouge">preview</code> ขึ้นมาเพื่อแกะพารามิเตอร์ <code class="highlighter-rouge">body</code> และ <code class="highlighter-rouge">id</code> ออกมาเท่านั้นจากนั้นก็ส่งค่าไปให้ view ในการแสดงผล ซึ่งใน view เองก็จะมีการเรียกใช้ helper ที่ชื่อ <code class="highlighter-rouge">to_markdown</code> ซึ่งจะทำการแปลง text ให้อยู่ในรูปของ <strong>Markdown</strong></p>

<div class="language-ruby highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># app/controllers/posts_controller.rb</span>
<span class="k">def</span> <span class="nf">preview</span>
  <span class="vi">@body</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:body</span><span class="p">]</span>
  <span class="vi">@id</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="ss">:id</span><span class="p">]</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;%# app/views/posts/preview.turbo_stream.erb %&gt;</span>
<span class="cp">&lt;%=</span> <span class="n">turbo_stream</span><span class="p">.</span><span class="nf">replace</span> <span class="s2">"post_</span><span class="si">#{</span><span class="vi">@id</span><span class="si">}</span><span class="s2">_preview"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%=</span> <span class="n">turbo_frame_tag</span> <span class="ss">:"post_</span><span class="si">#{</span><span class="vi">@id</span><span class="si">}</span><span class="ss">_preview"</span> <span class="k">do</span> <span class="cp">%&gt;</span>
    <span class="cp">&lt;%=</span> <span class="n">render</span> <span class="s2">"preview"</span><span class="p">,</span> <span class="ss">body: </span><span class="vi">@body</span> <span class="cp">%&gt;</span>
  <span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
<span class="cp">&lt;%</span> <span class="k">end</span> <span class="cp">%&gt;</span>
</code></pre></div></div>

<div class="language-erb highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">&lt;%# app/views/posts/_preview.html.erb %&gt;</span>
<span class="nt">&lt;div</span> <span class="na">class=</span><span class="s">"p-4 mt-4 rounded-sm"</span><span class="nt">&gt;</span>
  <span class="nt">&lt;h1</span> <span class="na">class=</span><span class="s">"text-black"</span><span class="nt">&gt;</span>Markdown Preview<span class="nt">&lt;/h1&gt;</span>
  <span class="nt">&lt;article</span> <span class="na">class=</span><span class="s">"prose"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;div</span> <span class="na">data-post-target=</span><span class="s">"bodyPreview"</span><span class="nt">&gt;</span>
      <span class="cp">&lt;%=</span> <span class="n">to_markdown</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="cp">%&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;/article&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>จากนั้นที่เหลือก็ปล่อยให้เมจิกของ <strong>Hotwired</strong> ได้ทำงาน โดยผลลัพท์ที่ได้ดังแสดงในวิดีโอด้านล่าง</p>

<video controls="" playsinline="">
  <source src="/videos/markdown_preview.mov" type="video/mp4" />
</video>

<h2 id="สรุป">สรุป</h2>

<p>สำหรับทั้งสองวิธีการยังคงให้ผลลัพท์ในการทำงานที่เหมือนกัน แต่ที่จะแตกต่างกันก็คือ เมื่อเราใช้งาน <strong>StiumulusReflex</strong> การส่งข้อมูลและอัพเดตข้อมูลจะกระทำผ่าน <strong>WebSocket</strong> เป็นหลักจะสังเกตได้จากรูปด้านล่าง</p>

<p><img src="/images/posts/2022/real-time-markdown-preview-with-turbo-stream/stimulus_reflex.png" alt="" width="600px" />
<em>Stimulus Reflex</em></p>

<p>แต่ในบทความนี้จะเป็นการ request ผ่าน HTTP</p>

<p><img src="/images/posts/2022/real-time-markdown-preview-with-turbo-stream/turbo_stream.png" alt="" width="600px" />
<em>Turbo Stream</em></p>

</main>

    </main>
  </body>
</html>
